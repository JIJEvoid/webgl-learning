!function(a,b){"object"==typeof exports&&"undefined"!=typeof module?module.exports=b():"function"==typeof define&&define.amd?define(b):a.GlslCanvas=b()}(this,function(){"use strict";function b(a,b){return b={exports:{}},a(b,b.exports),b.exports}function g(a){var b=f.call(a);return"[object Function]"===b||"function"==typeof a&&"[object RegExp]"!==b||"undefined"!=typeof window&&(a===window.setTimeout||a===window.alert||a===window.confirm||a===window.prompt)}function l(a,b,c){if(!e(b))throw new TypeError("iterator must be a function");arguments.length<3&&(c=this),"[object Array]"===j.call(a)?m(a,b,c):"string"==typeof a?n(a,b,c):o(a,b,c)}function m(a,b,c){for(var d=0,e=a.length;e>d;d++)k.call(a,d)&&b.call(c,a[d],d,a)}function n(a,b,c){for(var d=0,e=a.length;e>d;d++)b.call(c,a.charAt(d),d,a)}function o(a,b,c){for(var d in a)k.call(a,d)&&b.call(c,a[d],d,a)}function t(){var b,c,d,a={};for(b=0;b<arguments.length;b++){c=arguments[b];for(d in c)s.call(c,d)&&(a[d]=c[d])}return a}function w(a,b){for(var c=0;c<a.length;c++)b(a[c])}function x(a){for(var b in a)if(a.hasOwnProperty(b))return!1;return!0}function y(a,b,c){var d=a;return e(b)?(c=b,"string"==typeof a&&(d={uri:a})):d=r(b,{uri:a}),d.callback=c,d}function z(a,b,c){return b=y(a,b,c),A(b)}function A(a){function d(){4===h.readyState&&setTimeout(g,0)}function e(){var a=void 0;if(a=h.response?h.response:h.responseText||B(h),p)try{a=JSON.parse(a)}catch(b){}return a}function f(a){return clearTimeout(r),a instanceof Error||(a=new Error(""+(a||"Unknown XMLHttpRequest Error"))),a.statusCode=0,c(a,s)}function g(){var b,d,f;if(!j)return clearTimeout(r),b=a.useXDR&&void 0===h.status?200:1223===h.status?204:h.status,d=s,f=null,0!==b?(d={body:e(),statusCode:b,method:l,headers:{},url:k,rawRequest:h},h.getAllResponseHeaders&&(d.headers=q(h.getAllResponseHeaders()))):f=new Error("Internal XMLHttpRequest Error"),c(f,d,d.body)}var b,c,h,i,j,k,l,m,n,o,p,r,s;if("undefined"==typeof a.callback)throw new Error("callback argument missing");if(b=!1,c=function(c,d,e){b||(b=!0,a.callback(c,d,e))},h=a.xhr||null,h||(h=a.cors||a.useXDR?new z.XDomainRequest:new z.XMLHttpRequest),k=h.url=a.uri||a.url,l=h.method=a.method||"GET",m=a.body||a.data,n=h.headers=a.headers||{},o=!!a.sync,p=!1,s={body:void 0,headers:{},statusCode:0,method:l,url:k,rawRequest:h},"json"in a&&a.json!==!1&&(p=!0,n["accept"]||n["Accept"]||(n["Accept"]="application/json"),"GET"!==l&&"HEAD"!==l&&(n["content-type"]||n["Content-Type"]||(n["Content-Type"]="application/json"),m=JSON.stringify(a.json===!0?m:a.json))),h.onreadystatechange=d,h.onload=g,h.onerror=f,h.onprogress=function(){},h.onabort=function(){j=!0},h.ontimeout=f,h.open(l,k,!o,a.username,a.password),o||(h.withCredentials=!!a.withCredentials),!o&&a.timeout>0&&(r=setTimeout(function(){if(!j){j=!0,h.abort("timeout");var a=new Error("XMLHttpRequest timeout");a.code="ETIMEDOUT",f(a)}},a.timeout)),h.setRequestHeader)for(i in n)n.hasOwnProperty(i)&&h.setRequestHeader(i,n[i]);else if(a.headers&&!x(a.headers))throw new Error("Headers cannot be set on an XDomainRequest object");return"responseType"in a&&(h.responseType=a.responseType),"beforeSend"in a&&"function"==typeof a.beforeSend&&a.beforeSend(h),h.send(m||null),h}function B(a){try{if("document"===a.responseType)return a.responseXML;var b=a.responseXML&&"parsererror"===a.responseXML.documentElement.nodeName;if(""===a.responseType&&!b)return a.responseXML}catch(c){}return null}function C(){}function J(a){return'\n<table style="background-color: #8CE; width: 100%; height: 100%;"><tr>\n<td align="center">\n<div style="display: table-cell; vertical-align: middle;">\n<div style="">'+a+"</div>\n</div>\n</td></tr></table>\n"}function O(a,b,c){function d(b){var c=a.parentNode;c&&(c.innerHTML=J(b))}function e(a,b){"function"==typeof c?c(a):d(b)}if(!window.WebGLRenderingContext)return e(M,K),null;var f=P(a,b);return f?f.getExtension("OES_standard_derivatives"):e(N,L),f}function P(a,b){var e,c=["webgl","experimental-webgl"],d=null;for(e=0;e<c.length;++e)try{d=a.getContext(c[e],b)}catch(f){if(d)break}return d}function Q(a,b,c,d){var g,e=a.gl,f=e.createShader(c);return e.shaderSource(f,b),e.compileShader(f),g=e.getShaderParameter(f,e.COMPILE_STATUS),g?f:(I=e.getShaderInfoLog(f),console.error("*** Error compiling shader "+f+":"+I),a.trigger("error",{shader:f,source:b,type:c,error:I,offset:d||0}),e.deleteShader(f),null)}function R(a,b,c,d){var g,h,i,e=a.gl,f=e.createProgram();for(g=0;g<b.length;++g)e.attachShader(f,b[g]);if(c)for(h=0;h<c.length;++h)e.bindAttribLocation(f,d?d[h]:h,c[h]);return e.linkProgram(f),i=e.getProgramParameter(f,e.LINK_STATUS),i?f:(I=e.getProgramInfoLog(f),console.log("Error in program linking:"+I),e.deleteProgram(f),null)}function S(a){var d,e,f,b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,c=[];for(d in a)if(e=a[d],f=void 0,b&&(d=b+"."+d),"number"==typeof e)c.push({type:"float",method:"1f",name:d,value:e});else if(Array.isArray(e)){if("number"==typeof e[0])1===e.length?c.push({type:"float",method:"1f",name:d,value:e}):e.length>=2&&e.length<=4?c.push({type:"vec"+e.length,method:e.length+"fv",name:d,value:e}):e.length>4&&c.push({type:"float[]",method:"1fv",name:d+"[0]",value:e});else if("string"==typeof e[0])c.push({type:"sampler2D",method:"1i",name:d,value:e});else if(Array.isArray(e[0])&&"number"==typeof e[0][0]){if(e[0].length>=2&&e[0].length<=4)for(f=0;f<e.length;f++)c.push({type:"vec"+e[0].length,method:e[f].length+"fv",name:d+"["+f+"]",value:e[f]})}else if("object"===D(e[0]))for(f=0;f<e.length;f++)c.push.apply(c,H(S(e[f],d+"["+f+"]")))}else"boolean"==typeof e?c.push({type:"bool",method:"1i",name:d,value:e}):"string"==typeof e?c.push({type:"sampler2D",method:"1i",name:d,value:e}):"object"===("undefined"==typeof e?"undefined":D(e))&&c.push.apply(c,H(S(e,d)));return c}function T(a){return a.getBoundingClientRect().top+a.height>0&&a.getBoundingClientRect().top<(window.innerHeight||document.documentElement.clientHeight)}function U(a){return 0===(a&a-1)}function V(){return/^((?!chrome|android).)*safari/i.test(navigator.userAgent)}function W(a,b){return a&&b?a.toString()!==b.toString():!1}function X(a){var b=new Set;return Object.assign(a,{on:function(a,c){var d={};d[a]=c,b.add(d)},off:function(a,c){var d,e,f,g,i,h,j,k,l,m,o,n,p;if(c)d={},d[a]=c,b.delete(d);else{e=!0,f=!1,g=void 0;try{for(h=b[Symbol.iterator]();!(e=(i=h.next()).done);e=!0){j=i.value,k=!0,l=!1,m=void 0;try{for(n=Object.keys(j)[Symbol.iterator]();!(k=(o=n.next()).done);k=!0)if(p=o.value,p===a)return b.delete(j),void 0}catch(q){l=!0,m=q}finally{try{!k&&n.return&&n.return()}finally{if(l)throw m}}}}catch(q){f=!0,g=q}finally{try{!e&&h.return&&h.return()}finally{if(f)throw g}}}},listSubscriptions:function(){var f,e,g,a=!0,c=!1,d=void 0;try{for(e=b[Symbol.iterator]();!(a=(f=e.next()).done);a=!0)g=f.value,console.log(g)}catch(h){c=!0,d=h}finally{try{!a&&e.return&&e.return()}finally{if(c)throw d}}},subscribe:function(a){b.add(a)},unsubscribe:function(a){b.delete(a)},unsubscribeAll:function(){b.clear()},trigger:function(a){var c,d,e,f,g,h,j,i,k;for(c=arguments.length,d=Array(c>1?c-1:0),e=1;c>e;e++)d[e-1]=arguments[e];f=!0,g=!1,h=void 0;try{for(i=b[Symbol.iterator]();!(f=(j=i.next()).done);f=!0)k=j.value,"function"==typeof k[a]&&k[a].apply(k,H(d))}catch(l){g=!0,h=l}finally{try{!f&&i.return&&i.return()}finally{if(g)throw h}}}})}function $(){var b,c,a=document.getElementsByClassName("glslCanvas");if(a.length>0)for(window.glslCanvases=[],b=0;b<a.length;b++)c=new Z(a[b]),c.isValid&&window.glslCanvases.push(c)}var c,d,e,f,h,i,j,k,p,q,r,s,u,v,D,F,G,H,I,K,L,M,N,Y,Z,a="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};return c="undefined"!=typeof window?window:"undefined"!=typeof a?a:"undefined"!=typeof self?self:{},d=c,e=g,f=Object.prototype.toString,h=b(function(a,b){function c(a){return a.replace(/^\s*|\s*$/g,"")}b=a.exports=c,b.left=function(a){return a.replace(/^\s*/,"")},b.right=function(a){return a.replace(/\s*$/,"")}}),i=l,j=Object.prototype.toString,k=Object.prototype.hasOwnProperty,p=function(a){return"[object Array]"===Object.prototype.toString.call(a)},q=function(a){if(!a)return{};var b={};return i(h(a).split("\n"),function(a){var c=a.indexOf(":"),d=h(a.slice(0,c)).toLowerCase(),e=h(a.slice(c+1));"undefined"==typeof b[d]?b[d]=e:p(b[d])?b[d].push(e):b[d]=[b[d],e]}),b},r=t,s=Object.prototype.hasOwnProperty,u=z,v=z,z.XMLHttpRequest=d.XMLHttpRequest||C,z.XDomainRequest="withCredentials"in new z.XMLHttpRequest?z.XMLHttpRequest:d.XDomainRequest,w(["get","put","post","patch","head","delete"],function(a){z["delete"===a?"del":a]=function(b,c,d){return c=y(b,c,d),c.method=a.toUpperCase(),A(c)}}),u.default=v,D="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},function(){function a(a){this.value=a}function b(b){function e(a,b){return new Promise(function(e,g){var h={key:a,arg:b,resolve:e,reject:g,next:null};d?d=d.next=h:(c=d=h,f(a,b))})}function f(c,d){var e,h;try{e=b[c](d),h=e.value,h instanceof a?Promise.resolve(h.value).then(function(a){f("next",a)},function(a){f("throw",a)}):g(e.done?"return":"normal",e.value)}catch(i){g("throw",i)}}function g(a,b){switch(a){case"return":c.resolve({value:b,done:!0});break;case"throw":c.reject(b);break;default:c.resolve({value:b,done:!1})}c=c.next,c?f(c.key,c.arg):d=null}var c,d;this._invoke=e,"function"!=typeof b.return&&(this.return=void 0)}return"function"==typeof Symbol&&Symbol.asyncIterator&&(b.prototype[Symbol.asyncIterator]=function(){return this}),b.prototype.next=function(a){return this._invoke("next",a)},b.prototype.throw=function(a){return this._invoke("throw",a)},b.prototype.return=function(a){return this._invoke("return",a)},{wrap:function(a){return function(){return new b(a.apply(this,arguments))}},await:function(b){return new a(b)}}}(),F=function(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")},G=function(){function a(a,b){var c,d;for(c=0;c<b.length;c++)d=b[c],d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),H=function(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}return Array.from(a)},I="",K='\n	This page requires a browser that supports WebGL.<br/>\n	<a href="http://get.webgl.org">Click here to upgrade your browser.</a>\n',L='\n	It does not appear your computer can support WebGL.<br/>\n	<a href="http://get.webgl.org/troubleshooting/">Click here for more information.</a>\n',M=1,N=2,Y=function(){function a(b,c){var d=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};F(this,a),X(this),this.gl=b,this.texture=b.createTexture(),this.texture&&(this.valid=!0),this.bind(),this.name=c,this.source=null,this.sourceType=null,this.loading=null,this.setData(1,1,new Uint8Array([0,0,0,255]),{filtering:"linear"}),this.setFiltering(d.filtering),this.load(d)}return G(a,[{key:"destroy",value:function(){this.valid&&(this.gl.deleteTexture(this.texture),this.texture=null,delete this.data,this.data=null,this.valid=!1)}},{key:"bind",value:function(b){this.valid&&("number"==typeof b&&a.activeUnit!==b&&(this.gl.activeTexture(this.gl.TEXTURE0+b),a.activeUnit=b),a.activeTexture!==this.texture&&(this.gl.bindTexture(this.gl.TEXTURE_2D,this.texture),a.activeTexture=this.texture))}},{key:"load",value:function(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.loading=null,"string"==typeof a.url?(void 0===this.url||a.url!==this.url)&&this.setUrl(a.url,a):a.element?this.setElement(a.element,a):a.data&&a.width&&a.height&&this.setData(a.width,a.height,a.data,a)}},{key:"setUrl",value:function(a){var b=this,c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(this.valid)return this.url=a,this.source=this.url,this.sourceType="url",this.loading=new Promise(function(d){var f=a.split(".").pop().toLowerCase(),g="ogv"===f||"webm"===f||"mp4"===f,h=void 0;g?(h=document.createElement("video"),h.autoplay=!0,c.filtering="nearest"):h=new Image,h.onload=function(){try{b.setElement(h,c)}catch(a){console.log("Texture '"+b.name+"': failed to load url: '"+b.source+"'",a,c)}d(b)},h.onerror=function(a){console.log("Texture '"+b.name+"': failed to load url: '"+b.source+"'",a,c),d(b)},V()&&"data:"===b.source.slice(0,5)||(h.crossOrigin="anonymous"),h.src=b.source,g&&b.setElement(h,c)}),this.loading}},{key:"setData",value:function(a,b,c){var d=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return this.width=a,this.height=b,this.source=c,this.sourceType="data",this.update(d),this.setFiltering(d),this.loading=Promise.resolve(this),this.loading}},{key:"setElement",value:function(a,b){var e,c=this,d=a;return"string"==typeof a&&(a=document.querySelector(a)),a instanceof HTMLCanvasElement||a instanceof HTMLImageElement||a instanceof HTMLVideoElement?(this.source=a,this.sourceType="element",a instanceof HTMLVideoElement?(a.addEventListener("canplaythrough",function(){c.intervalID=setInterval(function(){c.update(b)},15)},!0),a.addEventListener("ended",function(){a.currentTime=0,a.play()},!0)):this.update(b),this.setFiltering(b)):(e="the 'element' parameter (`element: "+JSON.stringify(d)+"`) must be a CSS ",e+="selector string, or a <canvas>, <image> or <video> object",console.log("Texture '"+this.name+"': "+e,b)),this.loading=Promise.resolve(this),this.loading}},{key:"update",value:function(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.valid&&(this.bind(),this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,a.UNPACK_FLIP_Y_WEBGL===!1?!1:!0),this.gl.pixelStorei(this.gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,a.UNPACK_PREMULTIPLY_ALPHA_WEBGL||!1),"element"===this.sourceType&&(this.source instanceof HTMLCanvasElement||this.source instanceof HTMLVideoElement||this.source instanceof HTMLImageElement&&this.source.complete)?(this.source instanceof HTMLVideoElement?(this.width=this.source.videoWidth,this.height=this.source.videoHeight):(this.width=this.source.width,this.height=this.source.height),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,this.source)):"data"===this.sourceType&&this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.width,this.height,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,this.source),this.trigger("loaded",this))}},{key:"setFiltering",value:function(){var b,c,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.valid&&(this.powerOf2=U(this.width)&&U(this.height),b=this.powerOf2?"mipmap":"linear",this.filtering=a.filtering||b,c=this.gl,this.bind(),this.powerOf2?(c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,a.TEXTURE_WRAP_S||a.repeat&&c.REPEAT||c.CLAMP_TO_EDGE),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,a.TEXTURE_WRAP_T||a.repeat&&c.REPEAT||c.CLAMP_TO_EDGE),"mipmap"===this.filtering?(c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.LINEAR_MIPMAP_LINEAR),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.LINEAR),c.generateMipmap(c.TEXTURE_2D)):"linear"===this.filtering?(c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.LINEAR),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.LINEAR)):"nearest"===this.filtering&&(c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.NEAREST),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.NEAREST))):(c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE),"mipmap"===this.filtering&&(this.filtering="linear"),"nearest"===this.filtering?(c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.NEAREST),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.NEAREST)):(c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.LINEAR),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.LINEAR))))}}]),a}(),Y.getMaxTextureSize=function(a){return a.getParameter(a.MAX_TEXTURE_SIZE)},Y.activeUnit=-1,Z=function(){function a(b,c,d){function o(){n.nMouse>1&&n.setMouse(m),n.resize()&&(n.forceRender=!0),n.render(),window.requestAnimationFrame(o)}var f,g,h,i,j,k,l,m,n,e=this;if(F(this,a),X(this),c=c||{},d=d||{},!b.hasAttribute("data-fullscreen")||"1"!=b.getAttribute("data-fullscreen")&&"true"!=b.getAttribute("data-fullscreen")?(this.width=b.clientWidth,this.height=b.clientHeight):(this.width=window.innerWidth,this.height=window.innerHeight,b.width=window.innerWidth,b.height=window.innerHeight),this.canvas=b,this.gl=void 0,this.program=void 0,this.textures={},this.buffers={},this.uniforms={},this.vbo={},this.isValid=!1,this.BUFFER_COUNT=0,this.vertexString=c.vertexString||"\n#ifdef GL_ES\nprecision mediump float;\n#endif\n\nattribute vec2 a_position;\nattribute vec2 a_texcoord;\n\nvarying vec2 v_texcoord;\n\nvoid main() {\n    gl_Position = vec4(a_position, 0.0, 1.0);\n    v_texcoord = a_texcoord;\n}\n",this.fragmentString=c.fragmentString||"\n#ifdef GL_ES\nprecision mediump float;\n#endif\n\nvarying vec2 v_texcoord;\n\nvoid main(){\n    gl_FragColor = vec4(0.0);\n}\n",f=O(b,c,d.onError),f&&(this.gl=f,this.timeLoad=this.timePrev=performance.now(),this.timeDelta=0,this.forceRender=!0,this.paused=!1,this.realToCSSPixels=window.devicePixelRatio||1,b.style.backgroundColor=c.backgroundColor||"rgba(1,1,1,0)",b.hasAttribute("data-fragment")?this.fragmentString=b.getAttribute("data-fragment"):b.hasAttribute("data-fragment-url")&&(g=b.getAttribute("data-fragment-url"),u.get(g,function(a,b,c){e.load(c,e.vertexString)})),b.hasAttribute("data-vertex")?this.vertexString=b.getAttribute("data-vertex"):b.hasAttribute("data-vertex-url")&&(h=b.getAttribute("data-vertex-url"),u.get(h,function(a,b,c){e.load(e.fragmentString,c)})),this.load(),this.program)){if(i=f.getAttribLocation(this.program,"a_texcoord"),this.vbo.texCoords=f.createBuffer(),this.gl.bindBuffer(f.ARRAY_BUFFER,this.vbo.texCoords),this.gl.bufferData(f.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),f.STATIC_DRAW),this.gl.enableVertexAttribArray(i),this.gl.vertexAttribPointer(i,2,f.FLOAT,!1,0,0),j=f.getAttribLocation(this.program,"a_position"),this.vbo.vertices=f.createBuffer(),this.gl.bindBuffer(f.ARRAY_BUFFER,this.vbo.vertices),this.gl.bufferData(f.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),f.STATIC_DRAW),this.gl.enableVertexAttribArray(j),this.gl.vertexAttribPointer(j,2,f.FLOAT,!1,0,0),b.hasAttribute("data-textures")){k=b.getAttribute("data-textures").split(",");for(l in k)this.setUniform("u_tex"+l,k[l])}return m={x:0,y:0},document.addEventListener("mousemove",function(a){m.x=a.clientX||a.pageX,m.y=a.clientY||a.pageY},!1),n=this,this.setMouse({x:0,y:0}),o(),this}}return G(a,[{key:"destroy",value:function(){var a,b,c,d;this.animated=!1,this.isValid=!1;for(a in this.textures)a.destroy&&a.destroy();this.textures={};for(b in this.attribs)this.gl.deleteBuffer(this.attribs[b]);this.gl.useProgram(null),this.gl.deleteProgram(this.program);for(c in this.buffers)d=this.buffers[c],this.gl.deleteProgram(d.program);this.program=null,this.gl=null}},{key:"load",value:function(a,b){var c,d,e,f,g,h,i,j,k,l;if(b&&(this.vertexString=b),a&&(this.fragmentString=a),this.animated=!1,this.nDelta=(this.fragmentString.match(/u_delta/g)||[]).length,this.nTime=(this.fragmentString.match(/u_time/g)||[]).length,this.nDate=(this.fragmentString.match(/u_date/g)||[]).length,this.nMouse=(this.fragmentString.match(/u_mouse/g)||[]).length,this.animated=this.nDate>1||this.nTime>1||this.nMouse>1,c=this.fragmentString.search(/sampler2D/g))for(d=this.fragmentString.split("\n"),e=0;e<d.length&&(f=d[e].match(/uniform\s*sampler2D\s*([\w]*);\s*\/\/\s*([\w|\:\/\/|\.|\-|\_]*)/i),f&&(g=f[2].split(".").pop().toLowerCase(),f[1]&&f[2]&&("jpg"===g||"jpeg"===g||"png"===g||"ogv"===g||"webm"===g||"mp4"===g)&&this.setUniform(f[1],f[2])),!(h=d[e].match(/\s*void\s*main\s*/g)));e++);i=Q(this,this.vertexString,this.gl.VERTEX_SHADER),j=Q(this,this.fragmentString,this.gl.FRAGMENT_SHADER),j?this.isValid=!0:(j=Q(this,"void main(){\n	gl_FragColor = vec4(1.0);\n}",this.gl.FRAGMENT_SHADER),this.isValid=!1),k=R(this,[i,j]),this.gl.useProgram(k),this.gl.deleteShader(i),this.gl.deleteShader(j),this.program=k,this.change=!0,this.BUFFER_COUNT=0,l=this.getBuffers(this.fragmentString),Object.keys(l).length&&this.loadPrograms(l),this.buffers=l,this.texureIndex=this.BUFFER_COUNT,this.trigger("load",{}),this.forceRender=!0,this.render()}},{key:"test",value:function(a,b,c){function k(){j.paused=f,(b||c)&&j.load(e,d)}function l(){var d,e,f;j.forceRender=!0,j.render(),d=g.getQueryObjectEXT(h,g.QUERY_RESULT_AVAILABLE_EXT),e=j.gl.getParameter(g.GPU_DISJOINT_EXT),d&&!e?(f={wasValid:i,frag:b||j.fragmentString,vert:c||j.vertexString,timeElapsedMs:g.getQueryObjectEXT(h,g.QUERY_RESULT_EXT)/1e6},k(),a(f)):window.requestAnimationFrame(l)}var j,d=this.vertexString,e=this.fragmentString,f=this.paused,g=this.gl.getExtension("EXT_disjoint_timer_query"),h=g.createQueryEXT(),i=this.isValid;(b||c)&&(this.load(b,c),i=this.isValid,this.forceRender=!0,this.render()),this.paused=!0,g.beginQueryEXT(g.TIME_ELAPSED_EXT,h),this.forceRender=!0,this.render(),g.endQueryEXT(g.TIME_ELAPSED_EXT),j=this,l()}},{key:"loadTexture",value:function(a,b,c){var d=this;c||(c={}),"string"==typeof b?c.url=b:"object"===("undefined"==typeof b?"undefined":D(b))&&b.data&&b.width&&b.height?(c.data=b.data,c.width=b.width,c.height=b.height):"object"===("undefined"==typeof b?"undefined":D(b))&&(c.element=b),this.textures[a]?this.textures[a]&&(this.textures[a].load(c),this.textures[a].on("loaded",function(){d.forceRender=!0})):(this.textures[a]=new Y(this.gl,a,c),this.textures[a].on("loaded",function(){d.forceRender=!0}))}},{key:"refreshUniforms",value:function(){this.uniforms={}}},{key:"setUniform",value:function(a){var c,d,e,b={};for(c=arguments.length,d=Array(c>1?c-1:0),e=1;c>e;e++)d[e-1]=arguments[e];b[a]=d,this.setUniforms(b)}},{key:"setUniforms",value:function(a){var c,b=S(a);for(c in b)"sampler2D"===b[c].type?this.loadTexture(b[c].name,b[c].value[0]):this.uniform(b[c].method,b[c].type,b[c].name,b[c].value);this.forceRender=!0}},{key:"setMouse",value:function(a){var c,d,b=this.canvas.getBoundingClientRect();a&&a.x&&a.x>=b.left&&a.x<=b.right&&a.y&&a.y>=b.top&&a.y<=b.bottom&&(c=(a.x-b.left)*this.realToCSSPixels,d=this.canvas.height-(a.y-b.top)*this.realToCSSPixels,this.uniform("2f","vec2","u_mouse",c,d))}},{key:"uniform",value:function j(a,b,c){var j,d,e,f,g,h,i,k;for(this.uniforms[c]=this.uniforms[c]||{},j=this.uniforms[c],d=arguments.length,e=Array(d>3?d-3:0),f=3;d>f;f++)e[f-3]=arguments[f];if(g=W(j.value,e),g||this.change||!j.location||!j.value){j.name=c,j.type=b,j.value=e,j.method="uniform"+a,this.gl.useProgram(this.program),j.location=this.gl.getUniformLocation(this.program,c),this.gl[j.method].apply(this.gl,[j.location].concat(j.value));for(h in this.buffers)i=this.buffers[h],this.gl.useProgram(i.program),k=this.gl.getUniformLocation(i.program,c),this.gl[j.method].apply(this.gl,[k].concat(j.value))}}},{key:"uniformTexture",value:function(a,b,c){var d,e;if(void 0===this.textures[a])this.loadTexture(a,b,c);else{this.uniform("1i","sampler2D",a,this.texureIndex);for(d in this.buffers)e=this.buffers[d],this.gl.useProgram(e.program),this.gl.activeTexture(this.gl.TEXTURE0+this.texureIndex),this.gl.bindTexture(this.gl.TEXTURE_2D,this.textures[a].texture);this.gl.useProgram(this.program),this.gl.activeTexture(this.gl.TEXTURE0+this.texureIndex),this.gl.bindTexture(this.gl.TEXTURE_2D,this.textures[a].texture),this.uniform("2f","vec2",a+"Resolution",this.textures[a].width,this.textures[a].height)}}},{key:"resize",value:function(){var a,b;return this.width!==this.canvas.clientWidth||this.height!==this.canvas.clientHeight?(this.realToCSSPixels=window.devicePixelRatio||1,a=Math.floor(this.gl.canvas.clientWidth*this.realToCSSPixels),b=Math.floor(this.gl.canvas.clientHeight*this.realToCSSPixels),(this.gl.canvas.width!==a||this.gl.canvas.height!==b)&&(this.gl.canvas.width=a,this.gl.canvas.height=b,this.gl.viewport(0,0,this.gl.canvas.width,this.gl.canvas.height)),this.width=this.canvas.clientWidth,this.height=this.canvas.clientHeight,this.resizeSwappableBuffers(),!0):!1}},{key:"render",value:function(){var a,b,c,d,e;if(this.visible=T(this.canvas),this.forceRender||this.change||this.animated&&this.visible&&!this.paused){a=new Date,b=performance.now(),this.timeDelta=(b-this.timePrev)/1e3,this.timePrev=b,this.nDelta>1&&this.uniform("1f","float","u_delta",this.timeDelta),this.nTime>1&&this.uniform("1f","float","u_time",(b-this.timeLoad)/1e3),this.nDate&&this.uniform("4f","float","u_date",a.getFullYear(),a.getMonth(),a.getDate(),3600*a.getHours()+60*a.getMinutes()+a.getSeconds()+.001*a.getMilliseconds()),this.uniform("2f","vec2","u_resolution",this.canvas.width,this.canvas.height);for(c in this.buffers)d=this.buffers[c],this.uniform("1i","sampler2D",d.name,d.bundle.input.index);this.texureIndex=this.BUFFER_COUNT;for(e in this.textures)this.uniformTexture(e),this.texureIndex++;this.renderPrograms(),this.trigger("render",{}),this.change=!1,this.forceRender=!1}}},{key:"pause",value:function(){this.paused=!0}},{key:"play",value:function(){this.paused=!1}},{key:"renderPrograms",value:function(){var d,e,a=this.gl,b=a.canvas.width,c=a.canvas.height;a.viewport(0,0,b,c);for(d in this.buffers)e=this.buffers[d],e.bundle.render(b,c,e.program,e.name),a.bindFramebuffer(a.FRAMEBUFFER,null);a.useProgram(this.program),a.drawArrays(a.TRIANGLES,0,6)}},{key:"getBuffers",value:function(a){var b={};return a&&a.replace(/(?:^\s*)((?:#if|#elif)(?:\s*)(defined\s*\(\s*BUFFER_)(\d+)(?:\s*\))|(?:#ifdef)(?:\s*BUFFER_)(\d+)(?:\s*))/gm,function(){var c=arguments[3]||arguments[4];b["u_buffer"+c]={fragment:"#define BUFFER_"+c+"\n"+a}}),b}},{key:"loadPrograms",value:function(a){var e,f,g,h,b=this,c=this.gl,d=Q(b,b.vertexString,c.VERTEX_SHADER);for(e in a)f=a[e],g=Q(b,f.fragment,c.FRAGMENT_SHADER,1),g?b.isValid=!0:(g=Q(b,"void main(){\n	gl_FragColor = vec4(1.0);\n}",c.FRAGMENT_SHADER),b.isValid=!1),h=R(b,[d,g]),f.name=e,f.program=h,f.bundle=b.createSwappableBuffer(b.canvas.width,b.canvas.height,h),c.deleteShader(g);c.deleteShader(d)}},{key:"createSwappableBuffer",value:function(a,b,c){var d=this.createBuffer(a,b,c),e=this.createBuffer(a,b,c),f=this.gl;return{input:d,output:e,swap:function(){var a=d;d=e,e=a,this.input=d,this.output=e},render:function(a,b,c){f.useProgram(c),f.viewport(0,0,a,b),f.bindFramebuffer(f.FRAMEBUFFER,this.input.buffer),f.framebufferTexture2D(f.FRAMEBUFFER,f.COLOR_ATTACHMENT0,f.TEXTURE_2D,this.output.texture,0),f.drawArrays(f.TRIANGLES,0,6),this.swap()},resize:function(a,b,c){f.useProgram(c),f.viewport(0,0,a,b),this.input.resize(a,b),this.output.resize(a,b)}}}},{key:"createBuffer",value:function(a,b){var f,g,d=this.gl,e=this.BUFFER_COUNT;return this.BUFFER_COUNT+=2,d.getExtension("OES_texture_float"),f=d.createTexture(),d.activeTexture(d.TEXTURE0+e),d.bindTexture(d.TEXTURE_2D,f),d.texImage2D(d.TEXTURE_2D,0,d.RGBA,a,b,0,d.RGBA,d.FLOAT,null),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.NEAREST),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.NEAREST),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d.CLAMP_TO_EDGE),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d.CLAMP_TO_EDGE),g=d.createFramebuffer(),{index:e,texture:f,buffer:g,W:a,H:b,resize:function(a,b){var c,h,i,j,k,l;d.bindFramebuffer(d.FRAMEBUFFER,g),c=Math.min(a,this.W),h=Math.min(b,this.H),i=new Float32Array(4*c*h),d.readPixels(0,0,c,h,d.RGBA,d.FLOAT,i),d.bindFramebuffer(d.FRAMEBUFFER,null),j=e+1,k=d.createTexture(),d.activeTexture(d.TEXTURE0+j),d.bindTexture(d.TEXTURE_2D,k),d.texImage2D(d.TEXTURE_2D,0,d.RGBA,a,b,0,d.RGBA,d.FLOAT,null),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.NEAREST),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.NEAREST),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d.CLAMP_TO_EDGE),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d.CLAMP_TO_EDGE),d.texSubImage2D(d.TEXTURE_2D,0,0,0,c,h,d.RGBA,d.FLOAT,i),l=d.createFramebuffer(),d.bindFramebuffer(d.FRAMEBUFFER,null),d.deleteTexture(f),d.activeTexture(d.TEXTURE0+e),d.bindTexture(d.TEXTURE_2D,k),e=this.index=e,f=this.texture=k,g=this.buffer=l,this.W=a,this.H=b}}}},{key:"resizeSwappableBuffers",value:function(){var d,e,a=this.gl,b=a.canvas.width,c=a.canvas.height;a.viewport(0,0,b,c);for(d in this.buffers)e=this.buffers[d],e.bundle.resize(b,c,e.program,e.name);a.useProgram(this.program)}},{key:"version",value:function(){return"0.1.7"}}]),a}(),window.addEventListener("load",function(){$()}),Z});